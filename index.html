<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests de Repaso - GRUPO I Oposición Diplomática</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .question-card {
            border-left: 4px solid #3b82f6;
        }
        .answer-option {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .answer-option:hover {
            background-color: #eff6ff;
        }
        .correct {
            background-color: #d1fae5;
            border-color: #10b981;
        }
        .incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
        }
        .disabled {
            pointer-events: none;
        }
        /* Estilos para el diagrama */
        .diagram-container {
            border-top: 4px solid #8b5cf6; /* Morado para distinguir */
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="fixed top-0 left-0 right-0 bg-blue-700 text-white shadow-lg z-30 h-16 flex items-center justify-between px-6">
        <div class="flex items-center">
            <button id="menu-toggle" class="md:hidden mr-4 text-white focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <h1 class="text-xl md:text-2xl font-bold">Tests de Repaso - GRUPO I</h1>
        </div>
        <div id="scoreDisplay" class="text-lg font-semibold">Puntuación: 0 / 0</div>
    </div>
    
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden"></div>

    <div class="flex pt-16">
        <aside id="sidebar" class="w-64 bg-white shadow-xl p-4 transform -translate-x-full md:translate-x-0 fixed md:sticky top-0 md:top-16 z-20 h-full overflow-y-auto transition-transform duration-300 ease-in-out">
            <h2 class="text-lg font-semibold mb-4 text-blue-700">Temario</h2>
            <nav id="topicNav">
                <a href="diagramas.html" class="w-full text-left p-2 rounded-lg my-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 block font-semibold">
                    <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path></svg>
                    Ver Todos los Diagramas
                </a>
            </nav>
        </aside>

        <main id="main-content" class="flex-1 p-4 md:p-8 transition-all duration-300">
            <h2 id="quizTitle" class="text-2xl md:text-3xl font-bold mb-6 text-gray-700">Selecciona un tema para empezar</h2>
            <div id="quizContainer" class="space-y-6">
                </div>
            
            <div id="quizCompletion" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-8 rounded-lg" role="alert">
                <p class="font-bold text-xl mb-2">¡Cuestionario completado!</p>
                <p id="finalScore" class="text-lg"></p>
                <button onclick="restartQuiz()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">Repetir Test</button>
            </div>
        </main>
    </div>

    <script src="quizzes.js"></script>
    
    <script>
        // Inicializar Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });

        let currentQuizData = null;
        let currentAnswers = [];
        let score = 0;
        let totalQuestions = 0;

        function renderSidebar() {
            const nav = document.getElementById('topicNav');
            // Mantener el enlace a diagramas.html
            const diagramLink = nav.querySelector('a'); 
            nav.innerHTML = ''; 
            nav.appendChild(diagramLink);

            quizzesData.forEach((quiz, index) => {
                const button = document.createElement('button');
                button.className = `w-full text-left p-2 rounded-lg my-1 transition duration-150 ${quiz.questions.length > 0 ? 'bg-white hover:bg-blue-100 text-gray-700' : 'bg-gray-200 text-gray-500 cursor-not-allowed'}`;
                // Obtener solo el número del tema (ej: "T1") a partir del id (ej: "tema1")
                const themeNumber = quiz.id.replace('tema', 'T'); 
                button.innerHTML = `<strong>${themeNumber}:</strong> ${quiz.title}`;
                if (quiz.questions.length > 0) {
                    button.onclick = () => loadQuiz(index);
                }
                nav.appendChild(button);
            });
        }

        // Funcionalidad del menú móvil
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.remove('open');
            overlay.classList.add('hidden');
}

        async function loadQuiz(index) {
            currentQuizData = quizzesData[index];
            currentAnswers = Array(currentQuizData.questions.length).fill(null);
            score = 0;
            totalQuestions = 0;

            closeSidebar();

            document.getElementById('quizTitle').textContent = currentQuizData.title;
            document.getElementById('quizCompletion').classList.add('hidden');
            document.getElementById('scoreDisplay').textContent = 'Puntuación: 0 / 0';

            const container = document.getElementById('quizContainer');
            container.innerHTML = '';

            if (currentQuizData.questions.length === 0) {
                container.innerHTML = '<p class="text-xl text-red-600">⚠️ **Test no disponible aún:** Este tema está pendiente de completar. ¡Puedes ayudar rellenando las preguntas!</p>';
                return;
            }

            // Renderizar preguntas
            currentQuizData.questions.forEach((qData, qIndex) => {
                totalQuestions++;
                const qElement = document.createElement('div');
                qElement.id = `question-${qIndex}`;
                qElement.className = 'question-card bg-white p-6 rounded-xl shadow-lg';
                qElement.innerHTML = `
                    <p class="text-lg font-semibold mb-4 text-gray-800">Pregunta ${qIndex + 1}: ${qData.q}</p>
                    <div id="answers-${qIndex}" class="space-y-3">
                        ${qData.a.map((ans, aIndex) => `
                            <div id="answer-${qIndex}-${aIndex}" 
                                 class="answer-option p-3 border border-gray-200 rounded-lg"
                                 onclick="checkAnswer(${qIndex}, ${aIndex})">
                                <span class="font-medium">${String.fromCharCode(65 + aIndex)}.</span> ${ans}
                            </div>
                        `).join('')}
                    </div>
                    <div id="rationale-${qIndex}" class="mt-4 p-3 hidden rounded-lg"></div>
                `;
                container.appendChild(qElement);
            });

            // Renderizar Diagrama si existe (sin forzar el renderizado de Mermaid aquí, solo se muestra el contenedor)
            if (currentQuizData.diagram) {
                const diagramDiv = document.createElement('div');
                diagramDiv.className = "mt-8 p-6 bg-white rounded-xl shadow-lg diagram-container";
                diagramDiv.innerHTML = `
                    <h3 class="text-xl font-bold mb-4 text-purple-700 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Esquema Resumen: ${currentQuizData.title}
                    </h3>
                    <div class="mermaid flex justify-center overflow-x-auto p-4 bg-gray-50 rounded-lg">
                        ${currentQuizData.diagram}
                    </div>
                `;
                container.appendChild(diagramDiv);
                
                // Forzar renderizado de Mermaid para el nuevo contenido
                try {
                    await mermaid.run({
                        nodes: diagramDiv.querySelectorAll('.mermaid')
                    });
                } catch (e) {
                    console.error("Error renderizando diagrama:", e);
                }
            }
        }

        function checkAnswer(qIndex, aIndex) {
            if (currentAnswers[qIndex] !== null) return; // Already answered

            currentAnswers[qIndex] = aIndex;
            const questionElement = document.getElementById(`question-${qIndex}`);
            const answersContainer = document.getElementById(`answers-${qIndex}`);
            const rationaleElement = document.getElementById(`rationale-${qIndex}`);
            const correctIndex = currentQuizData.questions[qIndex].correct;
            const isCorrect = aIndex === correctIndex;

            // 1. Disable future clicks and highlight selected answer
            Array.from(answersContainer.children).forEach((child, index) => {
                child.classList.add('disabled');
                if (index === aIndex) {
                    child.classList.add(isCorrect ? 'correct' : 'incorrect');
                    child.classList.remove('hover:bg-blue-100');
                }
            });

            // 2. Highlight correct answer
            const correctAnswerElement = document.getElementById(`answer-${qIndex}-${correctIndex}`);
            correctAnswerElement.classList.add('correct', 'font-bold');

            // 3. Update score
            if (isCorrect) {
                score++;
            }
            updateScoreDisplay();

            // 4. Show rationale
            rationaleElement.classList.remove('hidden');
            rationaleElement.classList.add(isCorrect ? 'bg-green-50 border border-green-500 text-green-700' : 'bg-red-50 border border-red-500 text-red-700');
            rationaleElement.innerHTML = `
                <p class="font-bold">${isCorrect ? '¡Correcto!' : 'Incorrecto.'}</p>
                <p>${currentQuizData.questions[qIndex].rationale}</p>
            `;

            // 5. Check completion
            if (currentAnswers.every(ans => ans !== null)) {
                showCompletionMessage();
            }
        }

        function updateScoreDisplay() {
            document.getElementById('scoreDisplay').textContent = `Puntuación: ${score} / ${totalQuestions}`;
        }

        function showCompletionMessage() {
            const finalScoreElement = document.getElementById('finalScore');
            finalScoreElement.innerHTML = `Has obtenido **${score}** de **${totalQuestions}** preguntas correctas.`;
            document.getElementById('quizCompletion').classList.remove('hidden');
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function restartQuiz() {
            const currentIndex = quizzesData.findIndex(q => q.id === currentQuizData.id);
            if (currentIndex !== -1) {
                loadQuiz(currentIndex);
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar();
            // Automatically load the first available quiz
            const firstAvailableIndex = quizzesData.findIndex(q => q.questions.length > 0);
            if(firstAvailableIndex !== -1) {
                 loadQuiz(firstAvailableIndex);
            } else {
                 document.getElementById('quizTitle').textContent = "¡Carga completada! Todos los tests están pendientes de completar.";
            }

            // Mobile menu logic
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('hidden');
            });

            overlay.addEventListener('click', () => {
                closeSidebar();
            });
        });
    </script>

</body>
</html>